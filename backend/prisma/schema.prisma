// ==========================================
// CONFIG & DATASOURCE
// ==========================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. NHÓM HỆ THỐNG & PHÂN QUYỀN (CORE)
// ==========================================

model User {
  id                 String  @id @default(uuid())
  email              String  @unique
  password           String
  fullName           String
  isActive           Boolean @default(true)
  mustChangePassword Boolean @default(false)
  
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id])
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  // Scope nhà máy
  factoryId    String?  
  factory      Factory?   @relation("UserWorkingFactory", fields: [factoryId], references: [id])
  
  userPermissions    UserPermission[]
  posts              Post[]
  notifications      Notification[]

  // Workflow Relations
  createdTickets     Ticket[]        @relation("TicketCreator")
  actedSteps         TicketStep[]    @relation("StepActor") 
  approvalLogs       ApprovalLog[]

  // [ITAM - QUAN TRỌNG] Quan hệ N-N: Một User dùng nhiều máy
  assets             Asset[]         
}

model Role {
  id            String   @id 
  name          String
  description   String?
  users         User[]
  permissions   RolePermission[]
  workflowSteps WorkflowStep[] 
}

model Permission {
  id     String   @id 
  name   String
  module String
  roles  RolePermission[]
  users  UserPermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([roleId, permissionId])
}

model UserPermission {
  userId       String
  permissionId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([userId, permissionId])
}

model Department {
  id           String   @id 
  name         String
  name_content String   @default("Chưa có nội dung")
  
  factoryId    String?
  factory      Factory? @relation(fields: [factoryId], references: [id])

  users        User[]
  targetedPosts PostDepartment[]
  
  // [ITAM] Tài sản thuộc phòng ban này
  assets       Asset[] 
}

// ==========================================
// 2. GENERIC WORKFLOW ENGINE
// ==========================================

model Workflow {
  id                    String   @id @default(uuid())
  name                  String   
  code                  String   @unique 
  description           String?
  targetType            String   @default("STOCK")
  isActive              Boolean  @default(true)
  allowedInitiatorRoles String[] 
  
  steps                 WorkflowStep[]
  tickets               Ticket[]
}

model WorkflowStep {
  id             String   @id @default(uuid())
  workflowId     String
  workflow       Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  name           String   
  order          Int      
  approverType   String   @default("ROLE") 
  roleId         String?  
  role           Role?    @relation(fields: [roleId], references: [id])
  specificUserId String?  
  ticketSteps    TicketStep[]
}

model Ticket {
  id               String   @id @default(uuid())
  code             String   @unique 
  workflowId       String
  workflow         Workflow @relation(fields: [workflowId], references: [id])
  currentStep      Int      @default(0) 
  status           String   @default("PENDING") 
  creatorId        String
  creator          User     @relation("TicketCreator", fields: [creatorId], references: [id])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  completedAt      DateTime?
  
  steps            TicketStep[]
  logs             ApprovalLog[]
  stockTransaction StockTransaction? 
}

model TicketStep {
  id       String       @id @default(uuid())
  ticketId String
  ticket   Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  stepId   String
  step     WorkflowStep @relation(fields: [stepId], references: [id])
  status   String       @default("PENDING") 
  actorId  String?  
  actor    User?        @relation("StepActor", fields: [actorId], references: [id])
  note     String?
  actedAt  DateTime?
  @@unique([ticketId, stepId])
}

model ApprovalLog {
  id            String   @id @default(uuid())
  ticketId      String
  ticket        Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  action        String   
  comment       String?
  createdAt     DateTime @default(now())
}

// ==========================================
// 3. NGHIỆP VỤ KHO 
// ==========================================

model StockTransaction {
  id                String   @id @default(uuid())
  ticketId          String   @unique
  ticket            Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  type              String   
  isEmergency       Boolean  @default(false)
  description       String?
  factoryId         String
  factory           Factory  @relation(fields: [factoryId], references: [id])
  warehouseKeeperId String?  
  receiverId        String?  
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id])
  details           TransactionDetail[]
}

model TransactionDetail {
  id              String   @id @default(uuid())
  transactionId   String
  transaction     StockTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  itemId          String
  item            Item     @relation(fields: [itemId], references: [id])
  quantity        Float 
  inputUnit       String?  
  inputQuantity   Float?   
  fromLocationId  String?
  fromLocation    Location? @relation("FromLoc", fields: [fromLocationId], references: [id])
  
  toLocationId    String?   
  toLocation      Location? @relation("ToLoc", fields: [toLocationId], references: [id])
  
  usageCategoryId String?
  usageCategory   UsageCategory? @relation(fields: [usageCategoryId], references: [id])
}

// ==========================================
// 4. NHÓM QUẢN LÝ VẬT LÝ
// ==========================================

model Factory {
  id           String   @id @default(uuid())
  name         String   @unique 
  address      String?
  warehouses   Warehouse[] 
  departments  Department[]
  transactions StockTransaction[] 
  users        User[]   @relation("UserWorkingFactory")
  
  assets       Asset[]

  createdAt    DateTime @default(now())
}

model Warehouse {
  id            String   @id @default(uuid())
  warehouseCode String   @unique 
  name          String
  type          String   @default("PHYSICAL") 
  description   String?
  factoryId     String   
  factory       Factory  @relation(fields: [factoryId], references: [id])
  locations     Location[]
}

model Location {
  id           String   @id @default(uuid())
  locationCode String   @unique 
  qrCode       String   @unique 
  rack         String?
  level        String?
  bin          String?
  warehouseId  String
  warehouse    Warehouse @relation(fields: [warehouseId], references: [id])
  stocks       Stock[]
  fromDetails  TransactionDetail[] @relation("FromLoc")
  toDetails    TransactionDetail[] @relation("ToLoc")
}

// ==========================================
// 5. NHÓM VẬT TƯ & DANH MỤC
// ==========================================

model Item {
  id          String   @id @default(uuid())
  itemCode    String   @unique
  itemName    String   
  baseUnit    String   
  qrCode      String?  @unique
  minStock    Float    @default(0)
  categoryId  String
  category    ItemCategory @relation(fields: [categoryId], references: [id])
  stocks      Stock[]
  suppliers   ItemSupplier[]
  details     TransactionDetail[]
  conversions ItemUnitConversion[] 
}

model ItemUnitConversion {
  id       String @id @default(uuid())
  itemId   String
  unitName String 
  factor   Float  
  barcode  String? 
  item     Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  @@unique([itemId, unitName])
}

model ItemCategory {
  id   String @id @default(uuid())
  code String @unique  
  name String          
  items Item[]
}

model UsageCategory {
  id                 String   @id @default(uuid())
  code               String   @unique 
  name               String   
  description        String? 
  transactionDetails TransactionDetail[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Supplier {
  id           String   @id @default(uuid())
  supplierCode String   @unique
  name         String
  items        ItemSupplier[]
  stocks       Stock[]
  transactions StockTransaction[]
}

model ItemSupplier {
  itemId     String
  supplierId String
  item       Item     @relation(fields: [itemId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  @@id([itemId, supplierId])
}

model Stock {
  id         String   @id @default(uuid())
  itemId     String
  locationId String
  supplierId String?  
  quantity   Float    @default(0) 
  item       Item     @relation(fields: [itemId], references: [id])
  location   Location @relation(fields: [locationId], references: [id])
  supplier   Supplier? @relation(fields: [supplierId], references: [id])
  @@unique([itemId, locationId, supplierId])
}

// ==========================================
// 6. CÁC BẢNG CÔNG TÁC (CMS)
// ==========================================

model Post {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  attachments Json?
  published   Boolean  @default(true)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  menuId      Int
  menu        Menu     @relation(fields: [menuId], references: [id])
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  targets     PostDepartment[]
  @@map("posts")
}

model Menu {
  id       Int     @id @default(autoincrement())
  title    String
  slug     String?
  order    Int     @default(0)
  isVisible Boolean @default(true)
  parentId Int?
  parent   Menu?   @relation("MenuHierarchy", fields: [parentId], references: [id])
  children Menu[]  @relation("MenuHierarchy")
  posts    Post[]
  @@map("menus")
}

model PostDepartment {
  id           String     @id @default(uuid())
  postId       String
  departmentId String
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  @@map("notifications")
}

model TransactionCounter {
  key       String   @id
  count     Int
  updatedAt DateTime @updatedAt
}

// ==========================================
// 7. MODULE QUẢN LÝ TÀI SẢN (ITAM)
// ==========================================

model AssetType {
  id          String   @id @default(uuid())
  code        String   @unique 
  name        String   
  models      AssetModel[]
  assets      Asset[]
}

model AssetModel {
  id           String   @id @default(uuid())
  name         String   
  manufacturer String   
  modelNumber  String?  
  typeId       String
  type         AssetType @relation(fields: [typeId], references: [id])
  standardSpecs Json?   
  assets       Asset[]
  createdAt    DateTime @default(now())
}

model Asset {
  id           String   @id @default(uuid())
  name         String   @unique 
  serialNumber String?  
  
  modelId      String?
  model        AssetModel? @relation(fields: [modelId], references: [id])
  
  typeId       String
  type         AssetType @relation(fields: [typeId], references: [id])

  status       String   @default("NEW") 
  
  // Agent Data
  ipAddress    String?
  macAddress   String?
  osName       String?
  modelName    String?
  osVersion    String?  
  manufacturer String? 
  lastSeen     DateTime @default(now())
  customSpecs  Json?    

  // Hierarchy
  parentId     String?
  parent       Asset?      @relation("AssetHierarchy", fields: [parentId], references: [id])
  children     Asset[]     @relation("AssetHierarchy")

  // Location
  factoryId    String?
  factory      Factory?    @relation(fields: [factoryId], references: [id])
  
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  
  // [QUAN TRỌNG - SỬA LỖI] Quan hệ N-N với User (Nhiều người dùng 1 máy)
  users        User[]      
  
  // Details
  components   AssetComponent[]
  maintenances MaintenanceLog[]
  softwares    InstalledSoftware[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AssetComponent {
  id           String   @id @default(uuid())
  type         String   
  name         String   
  serialNumber String?  
  specs        Json?    
  assetId      String?
  asset        Asset?   @relation(fields: [assetId], references: [id])
  status       String   @default("ACTIVE") 
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model MaintenanceLog {
  id           String   @id @default(uuid())
  assetId      String
  asset        Asset    @relation(fields: [assetId], references: [id])
  type         String   
  description  String   
  providerType String   
  providerName String?  
  cost         Float    @default(0)
  startDate    DateTime @default(now())
  endDate      DateTime? 
  status       String   @default("IN_PROGRESS")
  createdAt    DateTime @default(now())
}

model InstalledSoftware {
  id           String   @id @default(uuid())
  name         String   
  version      String?
  publisher    String?
  installDate  DateTime?
  assetId      String
  asset        Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
}