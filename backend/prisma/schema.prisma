generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. NHÓM HỆ THỐNG & PHÂN QUYỀN
// ==========================================

model User {
  id                 String  @id
  email              String  @unique
  password           String
  fullName           String
  isActive           Boolean @default(true)
  mustChangePassword Boolean @default(false)
  
  roleId             String
  role               Role    @relation(fields: [roleId], references: [id])
  
  departmentId       String
  department         Department @relation(fields: [departmentId], references: [id])
  
  userPermissions    UserPermission[]
  posts              Post[]
  notifications      Notification[]

  createdTransactions   StockTransaction[]    @relation("CreatedBy")
  approvedSteps         TransactionApproval[] @relation("ActualApprover")
  keeperTransactions    StockTransaction[]    @relation("WarehouseKeeper")
  receivedTransactions  StockTransaction[]    @relation("Receiver")
  approvalLogs          ApprovalLog[]
}

model Role {
  id            String   @id
  name          String
  description   String?
  users         User[]
  permissions   RolePermission[]
  approvalSteps ApprovalStep[]
}

model Permission {
  id      String   @id
  name    String
  module  String
  roles   RolePermission[]
  users   UserPermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([roleId, permissionId])
}

model UserPermission {
  userId       String
  permissionId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([userId, permissionId])
}

model Department {
  id           String    @id
  name         String
  name_content String    @default("Chưa có nội dung")
  
  factoryId    String?
  factory      Factory?  @relation(fields: [factoryId], references: [id])

  users        User[]
  targetedPosts PostDepartment[]
}

// ==========================================
// 2. NHÓM QUẢN LÝ VẬT LÝ (KHO BÃI)
// ==========================================

model Factory {
  id           String      @id @default(uuid())
  
  // Dùng tên làm mã định danh luôn (VD: X1, X2) cho tiện
  name         String      @unique 
  address      String?
  
  warehouses   Warehouse[] 
  departments  Department[]
  transactions StockTransaction[] 
  
  createdAt    DateTime    @default(now())
}

model Warehouse {
  id            String   @id @default(uuid())
  warehouseCode String   @unique 
  name          String
  type          String   @default("PHYSICAL") 
  description   String?
  
  factoryId     String   
  factory       Factory  @relation(fields: [factoryId], references: [id])
  locations     Location[]
}

model Location {
  id           String    @id @default(uuid())
  locationCode String    @unique 
  qrCode       String    @unique 
  rack         String?
  level        String?
  bin          String?

  warehouseId  String
  warehouse    Warehouse @relation(fields: [warehouseId], references: [id])
  
  stocks       Stock[]
  fromDetails  TransactionDetail[] @relation("FromLoc")
  toDetails    TransactionDetail[] @relation("ToLoc")
}

// ==========================================
// 3. NHÓM VẬT TƯ & DANH MỤC (CẬP NHẬT MỚI)
// ==========================================

model Item {
  id           String   @id @default(uuid())
  itemCode     String   @unique
  itemName     String   
  
  // [CẬP NHẬT] Đổi tên thành baseUnit để rõ nghĩa (VD: Cái, Lít)
  baseUnit     String   
  
  qrCode       String?  @unique // Có thể null
  minStock     Float    @default(0)
  
  categoryId   String
  category     ItemCategory @relation(fields: [categoryId], references: [id])
  
  stocks       Stock[]
  suppliers    ItemSupplier[]
  details      TransactionDetail[]
  
  // [MỚI] Quan hệ với bảng quy đổi đơn vị
  conversions  ItemUnitConversion[] 
}

// [MỚI] Bảng quy đổi đơn vị (VD: 1 Thùng = 24 Cái)
model ItemUnitConversion {
  id          String  @id @default(uuid())
  itemId      String
  
  unitName    String  // Tên đơn vị (VD: Thùng, Hộp, Phuy)
  factor      Float   // Hệ số quy đổi ra Base Unit (VD: 24, 200)
  barcode     String? // Mã vạch riêng cho đơn vị này (nếu có)

  item        Item    @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, unitName])
}

model ItemCategory {
  id    String @id @default(uuid())
  code  String @unique  // Mã quản lý (VD: NHOM01)
  name  String          // Tên nhóm (VD: Văn phòng phẩm, Vật tư Kim khí)
  items Item[]
}

// UsageCategory: Phân loại mục đích sử dụng (VD: Bảo trì máy, Sản xuất...)
model UsageCategory {
  id          String   @id @default(uuid())
  code        String   @unique 
  name        String   
  description String? 

  transactionDetails TransactionDetail[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Supplier {
  id           String    @id @default(uuid())
  supplierCode String    @unique
  name         String
  items        ItemSupplier[]
  stocks       Stock[]
  transactions StockTransaction[]
}

model ItemSupplier {
  itemId     String
  supplierId String
  item       Item     @relation(fields: [itemId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  @@id([itemId, supplierId])
}

model Stock {
  id          String   @id @default(uuid())
  itemId      String
  locationId  String
  supplierId  String?
  
  // Luôn lưu theo Base Unit (VD: 1000 cái, 200.5 lít)
  quantity    Float    @default(0)
  
  item        Item     @relation(fields: [itemId], references: [id])
  location    Location @relation(fields: [locationId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@unique([itemId, locationId, supplierId])
}

// ==========================================
// 4. NHÓM PHÊ DUYỆT & GIAO DỊCH
// ==========================================

model TransactionCounter {
  key       String   @id 
  count     Int      
  updatedAt DateTime @updatedAt
}

model StockTransaction {
  id                String   @id @default(uuid())
  code              String   @unique // "26-01-001 | X1"
  type              String   // IMPORT, EXPORT, TRANSFER, INTERNAL_USE
  status            String   @default("PENDING")
  isEmergency       Boolean  @default(false)
  description       String?

  factoryId         String
  factory           Factory  @relation(fields: [factoryId], references: [id])

  creatorId         String
  creator           User     @relation("CreatedBy", fields: [creatorId], references: [id])
  
  warehouseKeeperId String?
  warehouseKeeper   User?    @relation("WarehouseKeeper", fields: [warehouseKeeperId], references: [id])
  
  receiverId        String?
  receiver          User?    @relation("Receiver", fields: [receiverId], references: [id])
  
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id])

  createdAt         DateTime @default(now())
  completedAt       DateTime?
  
  details           TransactionDetail[]
  approvals         TransactionApproval[]
  logs              ApprovalLog[]
}

model ApprovalStep {
  id        String   @id @default(uuid())
  name      String
  order     Int
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])
  type      String
  approvals TransactionApproval[]
}

model TransactionApproval {
  id            String   @id @default(uuid())
  transactionId String
  stepId        String
  approverId    String?
  status        String   @default("PENDING")
  
  transaction   StockTransaction @relation(fields: [transactionId], references: [id])
  step          ApprovalStep     @relation(fields: [stepId], references: [id])
  approver      User?            @relation("ActualApprover", fields: [approverId], references: [id])
  
  @@unique([transactionId, stepId])
}

model TransactionDetail {
  id              String   @id @default(uuid())
  transactionId   String
  itemId          String
  
  // Số lượng thực tế lưu kho (Đã quy đổi ra Base Unit)
  quantity        Float
  
  // [MỚI] Lưu lại đơn vị và số lượng lúc nhập liệu để đối chiếu
  inputUnit       String?  // VD: "Thùng"
  inputQuantity   Float?   // VD: 1

  fromLocationId  String?
  toLocationId    String?

  usageCategoryId String?
  usageCategory   UsageCategory? @relation(fields: [usageCategoryId], references: [id])

  transaction     StockTransaction @relation(fields: [transactionId], references: [id])
  item            Item             @relation(fields: [itemId], references: [id])
  fromLocation    Location?        @relation("FromLoc", fields: [fromLocationId], references: [id])
  toLocation      Location?        @relation("ToLoc", fields: [toLocationId], references: [id])
}

model ApprovalLog {
  id            String   @id @default(uuid())
  transactionId String
  userId        String
  action        String
  comment       String?
  createdAt     DateTime @default(now())
  
  transaction   StockTransaction @relation(fields: [transactionId], references: [id])
  user          User             @relation(fields: [userId], references: [id])
}

// ==========================================
// 5. CÁC BẢNG CÔNG TÁC (CMS)
// ==========================================

model Post {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  attachments Json?
  published   Boolean  @default(true)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  menuId      Int
  menu        Menu     @relation(fields: [menuId], references: [id])
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  targets     PostDepartment[]

  @@map("posts")
}

model Menu {
  id        Int     @id @default(autoincrement())
  title     String
  slug      String?
  order     Int     @default(0)
  isVisible Boolean @default(true)
  parentId  Int?
  parent    Menu?   @relation("MenuHierarchy", fields: [parentId], references: [id])
  children  Menu[]  @relation("MenuHierarchy")
  posts     Post[]

  @@map("menus")
}

model PostDepartment {
  id           String     @id @default(uuid())
  postId       String
  departmentId String
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  @@map("notifications")
}