generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. NHÓM HỆ THỐNG & PHÂN QUYỀN (CORE)
// ==========================================

model User {
  id                 String  @id @default(uuid())
  email              String  @unique
  password           String
  fullName           String
  isActive           Boolean @default(true)
  mustChangePassword Boolean @default(false)
  
  // Role & Dept
  roleId             String
  role               Role       @relation(fields: [roleId], references: [id])
  departmentId       String
  department         Department @relation(fields: [departmentId], references: [id])

  // [FACTORY SCOPE] User thuộc nhà máy nào?
  factoryId          String?  
  factory            Factory?   @relation("UserWorkingFactory", fields: [factoryId], references: [id])
  
  // Permissions
  userPermissions    UserPermission[]
  
  // CMS & System
  posts              Post[]
  notifications      Notification[]

  // === GENERIC WORKFLOW RELATIONS ===
  // Người tạo các phiếu yêu cầu (Ticket)
  createdTickets     Ticket[]        @relation("TicketCreator")
  
  // Lịch sử tham gia duyệt (đã duyệt bước nào)
  actedSteps         TicketStep[]    @relation("StepActor") 
  
  // Log thao tác
  approvalLogs       ApprovalLog[]
}

model Role {
  id            String   @id // (VD: "ROLE-ADMIN", "ROLE-USER", "ROLE-KHO")
  name          String
  description   String?
  
  users         User[]
  permissions   RolePermission[]
  
  // Role được dùng để định nghĩa người duyệt trong Workflow Template
  workflowSteps WorkflowStep[] 
}

model Permission {
  id      String   @id 
  name    String
  module  String
  roles   RolePermission[]
  users   UserPermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([roleId, permissionId])
}

model UserPermission {
  userId       String
  permissionId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  @@id([userId, permissionId])
}

model Department {
  id           String   @id 
  name         String
  name_content String   @default("Chưa có nội dung")
  
  factoryId    String?
  factory      Factory? @relation(fields: [factoryId], references: [id])

  users        User[]
  targetedPosts PostDepartment[]
}

// ==========================================
// 2. GENERIC WORKFLOW ENGINE (LÕI XỬ LÝ DUYỆT)
// Phần này dùng chung cho TẤT CẢ quy trình
// ==========================================

// 2.1. Định nghĩa Quy trình mẫu (Template)
model Workflow {
  id                    String   @id @default(uuid())
  name                  String   
  code                  String   @unique // VD: "WF-NHAP-KHO", "WF-NGHI-PHEP"
  description           String?
  
  // Loại đối tượng áp dụng để FE dễ filter: "STOCK", "HR", "FINANCE"
  targetType            String   @default("STOCK") 
  isActive              Boolean  @default(true)
  
  allowedInitiatorRoles String[] // Array Role ID được phép tạo
  
  steps                 WorkflowStep[]
  tickets               Ticket[]
}

// 2.2. Các bước trong mẫu (Template Steps)
// 2.2. Các bước trong mẫu (Template Steps)
model WorkflowStep {
  id             String   @id @default(uuid())
  workflowId     String
  workflow       Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  name           String   // VD: "Tổ trưởng xác nhận"
  order          Int      // 1, 2, 3...
  
  // Định nghĩa ai được duyệt bước này
  approverType   String   @default("ROLE") // "ROLE", "SPECIFIC_USER", "CREATOR"
  
  roleId         String?  
  role           Role?    @relation(fields: [roleId], references: [id])
  
  // [ADD NEW] Thêm trường này để lưu ID người cụ thể nếu chọn SPECIFIC_USER
  specificUserId String?  
  
  // Quan hệ ngược với các bước thực tế đang chạy
  ticketSteps    TicketStep[]
}

// 2.3. TICKET (PHIẾU YÊU CẦU - PROCESS INSTANCE)
// Đây là bảng trung tâm. Mọi yêu cầu (Kho, Nghỉ phép...) đều sinh ra 1 Ticket.
model Ticket {
  id           String   @id @default(uuid())
  code         String   @unique // Mã phiếu (VD: TICKET-2023-001)
  
  workflowId   String
  workflow     Workflow @relation(fields: [workflowId], references: [id])
  
  // Trạng thái chung
  currentStep  Int      @default(0) 
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  
  creatorId    String
  creator      User     @relation("TicketCreator", fields: [creatorId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime?

  // Lịch sử duyệt của Ticket này
  steps        TicketStep[]
  logs         ApprovalLog[]

  // === POLYMORPHIC RELATIONS (MỞ RỘNG Ở ĐÂY) ===
  // Mỗi Ticket sẽ link tới 1 trong các bảng nghiệp vụ bên dưới
  stockTransaction StockTransaction? 
  
  // Sau này mở rộng:
  // leaveRequest  LeaveRequest?
  // purchaseOrder PurchaseOrder?
}

// 2.4. Trạng thái thực tế của từng bước (Running Steps)
model TicketStep {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  stepId    String
  step      WorkflowStep @relation(fields: [stepId], references: [id])
  
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  actorId   String?  // Người thực tế đã duyệt
  actor     User?    @relation("StepActor", fields: [actorId], references: [id])
  
  note      String?
  actedAt   DateTime?
  
  @@unique([ticketId, stepId])
}

model ApprovalLog {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  action    String   // APPROVE, REJECT, COMMENT, CREATE
  comment   String?
  createdAt DateTime @default(now())
}

// ==========================================
// 3. NGHIỆP VỤ KHO (Gắn vào Ticket)
// ==========================================

model StockTransaction {
  id                String   @id @default(uuid())
  
  // Quan hệ 1-1 với Ticket (Bắt buộc)
  ticketId          String   @unique
  ticket            Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Dữ liệu đặc thù của Kho
  type              String   // "IMPORT", "EXPORT", "TRANSFER"
  isEmergency       Boolean  @default(false)
  description       String?

  factoryId         String
  factory           Factory  @relation(fields: [factoryId], references: [id])

  // Các bên liên quan (ngoài Creator/Approver đã có trong Ticket)
  warehouseKeeperId String?  // Thủ kho thực hiện (nếu cần tracking riêng)
  receiverId        String?  // Người nhận hàng
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id])

  details           TransactionDetail[]
}

model TransactionDetail {
  id              String   @id @default(uuid())
  transactionId   String
  transaction     StockTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  itemId          String
  item            Item     @relation(fields: [itemId], references: [id])
  
  quantity        Float 
  inputUnit       String?  
  inputQuantity   Float?   

  fromLocationId  String?
  fromLocation    Location? @relation("FromLoc", fields: [fromLocationId], references: [id])
  
  toLocationId    String?
  toLocation      Location? @relation("ToLoc", fields: [toLocationId], references: [id])

  usageCategoryId String?
  usageCategory   UsageCategory? @relation(fields: [usageCategoryId], references: [id])
}

// ==========================================
// 4. NHÓM QUẢN LÝ VẬT LÝ (KHO BÃI)
// ==========================================

model Factory {
  id           String    @id @default(uuid())
  name         String    @unique 
  address      String?
  
  warehouses   Warehouse[] 
  departments  Department[]
  transactions StockTransaction[] 
  
  users        User[]    @relation("UserWorkingFactory")
  createdAt    DateTime  @default(now())
}

model Warehouse {
  id            String   @id @default(uuid())
  warehouseCode String   @unique 
  name          String
  type          String   @default("PHYSICAL") 
  description   String?
  
  factoryId     String   
  factory       Factory  @relation(fields: [factoryId], references: [id])
  locations     Location[]
}

model Location {
  id           String   @id @default(uuid())
  locationCode String   @unique 
  qrCode       String   @unique 
  rack         String?
  level        String?
  bin          String?

  warehouseId  String
  warehouse    Warehouse @relation(fields: [warehouseId], references: [id])
  
  stocks       Stock[]
  fromDetails  TransactionDetail[] @relation("FromLoc")
  toDetails    TransactionDetail[] @relation("ToLoc")
}

// ==========================================
// 5. NHÓM VẬT TƯ & DANH MỤC
// ==========================================

model Item {
  id           String   @id @default(uuid())
  itemCode     String   @unique
  itemName     String   
  baseUnit     String   
  
  qrCode       String?  @unique
  minStock     Float    @default(0)
  
  categoryId   String
  category     ItemCategory @relation(fields: [categoryId], references: [id])
  
  stocks       Stock[]
  suppliers    ItemSupplier[]
  details      TransactionDetail[]
  conversions  ItemUnitConversion[] 
}

model ItemUnitConversion {
  id       String @id @default(uuid())
  itemId   String
  unitName String 
  factor   Float  
  barcode  String? 

  item     Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  @@unique([itemId, unitName])
}

model ItemCategory {
  id    String @id @default(uuid())
  code  String @unique  
  name  String          
  items Item[]
}

model UsageCategory {
  id          String   @id @default(uuid())
  code        String   @unique 
  name        String   
  description String? 

  transactionDetails TransactionDetail[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Supplier {
  id           String   @id @default(uuid())
  supplierCode String   @unique
  name         String
  items        ItemSupplier[]
  stocks       Stock[]
  transactions StockTransaction[]
}

model ItemSupplier {
  itemId     String
  supplierId String
  item       Item     @relation(fields: [itemId], references: [id])
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  @@id([itemId, supplierId])
}

model Stock {
  id          String   @id @default(uuid())
  itemId      String
  locationId  String
  supplierId  String?  
  quantity    Float    @default(0) 
  
  item        Item     @relation(fields: [itemId], references: [id])
  location    Location @relation(fields: [locationId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@unique([itemId, locationId, supplierId])
}

// ==========================================
// 6. CÁC BẢNG CÔNG TÁC (CMS)
// ==========================================

model Post {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  attachments Json?
  published   Boolean  @default(true)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  menuId      Int
  menu        Menu     @relation(fields: [menuId], references: [id])
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  targets     PostDepartment[]

  @@map("posts")
}

model Menu {
  id        Int     @id @default(autoincrement())
  title     String
  slug      String?
  order     Int     @default(0)
  isVisible Boolean @default(true)
  parentId  Int?
  parent    Menu?   @relation("MenuHierarchy", fields: [parentId], references: [id])
  children  Menu[]  @relation("MenuHierarchy")
  posts     Post[]

  @@map("menus")
}

model PostDepartment {
  id           String     @id @default(uuid())
  postId       String
  departmentId String
  post         Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  @@map("notifications")
}

model TransactionCounter {
  key       String   @id
  count     Int
  updatedAt DateTime @updatedAt
}